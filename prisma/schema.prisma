generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String        @id @default(uuid())
  phoneNumber       String        @unique
  countryCode       String
  email             String?       @unique
  role              UserRole      @default(USER)
  status            UserStatus    @default(ACTIVE)
  kycStatus         KYCStatus     @default(NOT_STARTED)
  kycProviderId     String?
  kycData           Json?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  lastLoginAt       DateTime?
  metadata          Json?
  twoFactorEnabled  Boolean       @default(false)
  twoFactorSecret   String?
  userType          UserType      @default(STANDARD)
  referralCode      String?       @unique
  referredBy        String?
  totalSpent        Decimal       @default(0) @db.Decimal(20, 8)
  totalReferrals    Int           @default(0)
  subscriptionTier  String        @default("free")
  apiKeys           ApiKey[]
  auditLogs         AuditLog[]
  createdEmployees  Employee[]    @relation("CreatedByUser")
  employeeProfile   Employee?
  favorites         Favorite[]
  kycDocuments      KYCDocument[]
  orders            Order[]
  sellerProfile     Seller?
  transactions      Transaction[]
  addresses         UserAddress[]
  sessions          UserSession[]
  wallets           Wallet[]
  referrer          User?         @relation("UserReferrals", fields: [referredBy], references: [id])
  referrals         User[]        @relation("UserReferrals")
  rewards           Reward[]

  @@index([phoneNumber])
  @@index([email])
  @@index([kycStatus])
  @@index([role])
  @@index([referralCode])
  @@index([referredBy])
  @@map("users")
}

model UserSession {
  id           String    @id @default(uuid())
  userId       String
  token        String    @unique
  refreshToken String?   @unique
  deviceInfo   Json?
  ipAddress    String?
  expiresAt    DateTime
  createdAt    DateTime  @default(now())
  revokedAt    DateTime?
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("user_sessions")
}

model KYCDocument {
  id              String    @id @default(uuid())
  userId          String
  documentType    String
  documentUrl     String
  status          KYCStatus
  submittedAt     DateTime  @default(now())
  reviewedAt      DateTime?
  reviewedBy      String?
  rejectionReason String?
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("kyc_documents")
}

model Wallet {
  id             String         @id @default(uuid())
  userId         String
  stablecoinType StablecoinType
  network        NetworkType
  depositAddress String         @unique
  balance        Decimal        @default(0) @db.Decimal(20, 8)
  lockedBalance  Decimal        @default(0) @db.Decimal(20, 8)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  deposits       Deposit[]
  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  withdrawals    Withdrawal[]

  @@unique([userId, stablecoinType, network])
  @@index([userId])
  @@index([depositAddress])
  @@map("wallets")
}

model UserAddress {
  id           String      @id @default(uuid())
  userId       String
  type         AddressType
  label        String?
  fullName     String
  phone        String
  addressLine1 String
  addressLine2 String?
  city         String
  state        String?
  postalCode   String
  country      String
  isDefault    Boolean     @default(false)
  metadata     Json?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  orders       Order[]
  user         User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, type])
  @@index([userId, isDefault])
  @@map("user_addresses")
}

model Employee {
  id            String             @id @default(uuid())
  userId        String             @unique
  role          EmployeeRole
  permissions   Json
  department    String?
  isActive      Boolean            @default(true)
  createdBy     String
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  lastActiveAt  DateTime?
  activities    EmployeeActivity[]
  createdByUser User               @relation("CreatedByUser", fields: [createdBy], references: [id])
  user          User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([role])
  @@index([isActive])
  @@map("employees")
}

model EmployeeActivity {
  id          String   @id @default(uuid())
  employeeId  String
  action      String
  entityType  String
  entityId    String
  description String?
  metadata    Json?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())
  employee    Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([employeeId])
  @@index([action])
  @@index([entityType])
  @@index([createdAt])
  @@map("employee_activities")
}

model MasterKey {
  id                  String               @id @default(uuid())
  network             BlockchainNetwork    @unique
  encryptedSeed       String
  encryptedPrivateKey String?
  publicAddress       String               @unique
  derivationPath      String?
  createdBy           String
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  lastAccessedAt      DateTime?
  lastAccessedBy      String?
  isActive            Boolean              @default(true)
  metadata            Json?
  accessLogs          MasterKeyAccessLog[]

  @@index([network])
  @@index([createdBy])
  @@map("master_keys")
}

model MasterKeyAccessLog {
  id          String    @id @default(uuid())
  masterKeyId String
  accessedBy  String
  action      String
  ipAddress   String?
  userAgent   String?
  success     Boolean   @default(true)
  reason      String?
  createdAt   DateTime  @default(now())
  masterKey   MasterKey @relation(fields: [masterKeyId], references: [id], onDelete: Cascade)

  @@index([masterKeyId])
  @@index([accessedBy])
  @@index([createdAt])
  @@map("master_key_access_logs")
}

model Transaction {
  id                   String            @id @default(uuid())
  userId               String
  type                 TransactionType
  status               TransactionStatus @default(PENDING)
  stablecoinType       StablecoinType
  network              NetworkType?
  amount               Decimal           @db.Decimal(20, 8)
  fee                  Decimal           @default(0) @db.Decimal(20, 8)
  txHash               String?           @unique
  fromAddress          String?
  toAddress            String?
  orderId              String?           @unique
  metadata             Json?
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt
  completedAt          DateTime?
  failureReason        String?
  apiCommission        Decimal?          @db.Decimal(20, 8)
  apiKeyId             String?
  blockNumber          String?
  blockTimestamp       DateTime?
  confirmations        Int?              @default(0)
  gasUsed              String?
  platformFee          Decimal?          @db.Decimal(20, 8)
  smartContractAddress String?
  order                Order?            @relation(fields: [orderId], references: [id])
  user                 User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@index([status])
  @@index([txHash])
  @@index([network])
  @@index([apiKeyId])
  @@index([createdAt])
  @@map("transactions")
}

model Deposit {
  id               String            @id @default(uuid())
  walletId         String
  txHash           String            @unique
  fromAddress      String
  amount           Decimal           @db.Decimal(20, 8)
  confirmations    Int               @default(0)
  requiredConfirms Int               @default(12)
  status           TransactionStatus @default(PENDING)
  network          NetworkType
  blockNumber      BigInt?
  createdAt        DateTime          @default(now())
  confirmedAt      DateTime?
  wallet           Wallet            @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@index([walletId])
  @@index([status])
  @@index([txHash])
  @@map("deposits")
}

model Withdrawal {
  id            String            @id @default(uuid())
  walletId      String
  toAddress     String
  amount        Decimal           @db.Decimal(20, 8)
  networkFee    Decimal           @db.Decimal(20, 8)
  txHash        String?           @unique
  status        TransactionStatus @default(PENDING)
  network       NetworkType
  approvedBy    String?
  approvedAt    DateTime?
  createdAt     DateTime          @default(now())
  processedAt   DateTime?
  completedAt   DateTime?
  failureReason String?
  wallet        Wallet            @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@index([walletId])
  @@index([status])
  @@map("withdrawals")
}

model FiatPurchase {
  id               String              @id @default(uuid())
  userId           String
  provider         FiatPaymentProvider
  providerTxId     String              @unique
  stablecoinType   StablecoinType
  fiatAmount       Decimal             @db.Decimal(20, 2)
  fiatCurrency     String              @default("USD")
  stablecoinAmount Decimal             @db.Decimal(20, 8)
  exchangeRate     Decimal             @db.Decimal(20, 8)
  processingFee    Decimal             @db.Decimal(20, 2)
  status           FiatPaymentStatus   @default(INITIATED)
  paymentMethod    String?
  metadata         Json?
  createdAt        DateTime            @default(now())
  completedAt      DateTime?
  failureReason    String?

  @@index([userId])
  @@index([status])
  @@index([providerTxId])
  @@map("fiat_purchases")
}

model Seller {
  id                    String           @id @default(uuid())
  companyName           String
  tradingName           String?
  sellerType            SellerType
  status                SellerStatus     @default(PENDING_VERIFICATION)
  registrationNumber    String?
  taxId                 String?
  businessLicense       String?
  email                 String           @unique
  phone                 String?
  website               String?
  addressLine1          String?
  addressLine2          String?
  city                  String?
  state                 String?
  postalCode            String?
  country               String
  logo                  String?
  banner                String?
  description           String?
  rating                Decimal          @default(0) @db.Decimal(3, 2)
  totalReviews          Int              @default(0)
  totalSales            Int              @default(0)
  verifiedAt            DateTime?
  verifiedBy            String?
  rejectionReason       String?
  bankAccountName       String?
  bankAccountNumber     String?
  bankName              String?
  bankRoutingNumber     String?
  bankSwiftCode         String?
  payoutWalletAddress   String?
  payoutNetwork         NetworkType?
  commissionRate        Decimal          @default(0.10) @db.Decimal(5, 4)
  minOrderValue         Decimal?         @db.Decimal(20, 8)
  maxOrderValue         Decimal?         @db.Decimal(20, 8)
  metadata              Json?
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  userId                String?          @unique
  onboardingTokenExpiry DateTime?
  onboardingCompletedAt DateTime?
  documentsSubmittedAt  DateTime?
  approvedAt            DateTime?
  approvedBy            String?
  activatedAt           DateTime?
  activatedBy           String?
  isInhouse             Boolean          @default(false)
  onboardingToken       String?          @unique
  products              Product[]
  sellerDocuments       SellerDocument[]
  sellerPayouts         SellerPayout[]
  user                  User?            @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([status])
  @@index([sellerType])
  @@index([country])
  @@index([companyName])
  @@index([onboardingToken])
  @@index([email])
  @@map("sellers")
}

model SellerDocument {
  id            String         @id @default(uuid())
  sellerId      String
  documentType  String
  documentUrl   String
  reviewedAt    DateTime?
  reviewedBy    String?
  rejectionNote String?
  createdAt     DateTime       @default(now())
  fileSize      Int?
  mimeType      String?
  uploadedAt    DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  fileName      String
  status        DocumentStatus @default(PENDING)
  seller        Seller         @relation(fields: [sellerId], references: [id], onDelete: Cascade)

  @@index([sellerId])
  @@index([documentType])
  @@index([status])
  @@map("seller_documents")
}

model Product {
  id                String          @id @default(uuid())
  name              String
  description       String?
  imageUrl          String?
  category          String?
  status            ProductStatus   @default(PENDING_REVIEW)
  metadata          Json?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  barcode           String?
  brand             String?
  dimensions        Json?
  images            Json?
  isDigital         Boolean         @default(false)
  isFeatured        Boolean         @default(false)
  lowStockThreshold Int             @default(10)
  metaDescription   String?
  metaTitle         String?
  rating            Decimal         @default(0) @db.Decimal(3, 2)
  sellerId          String
  shippingClass     String?
  shortDescription  String?
  sku               String?
  slug              String?         @unique
  specifications    Json?
  stock             Int             @default(0)
  subcategory       String?
  tags              Json?
  totalReviews      Int             @default(0)
  videoUrl          String?
  weight            Decimal?        @db.Decimal(10, 2)
  adClicks          AdClick[]
  externalOrders    ExternalOrder[]
  favorites         Favorite[]
  orderItems        OrderItem[]
  prices            ProductPrice[]
  reviews           ProductReview[]
  seller            Seller          @relation(fields: [sellerId], references: [id])

  @@index([sellerId])
  @@index([status])
  @@index([category])
  @@index([brand])
  @@index([slug])
  @@map("products")
}

model DeletedProduct {
  id          String   @id @default(uuid())
  productId   String   @unique
  sellerId    String
  name        String
  description String?
  imageUrl    String?
  images      Json?
  category    String?
  brand       String?
  prices      Json?
  deletedBy   String
  deletedAt   DateTime @default(now())
  reason      String?
  metadata    Json?

  @@index([sellerId])
  @@index([deletedAt])
  @@index([deletedBy])
  @@map("deleted_products")
}

model Favorite {
  id        String   @id @default(uuid())
  userId    String
  productId String
  createdAt DateTime @default(now())
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([userId])
  @@index([productId])
  @@map("favorites")
}

model ProductReview {
  id           String   @id @default(uuid())
  productId    String
  customerId   String?
  userId       String?
  rating       Int
  title        String?
  comment      String?
  isVerified   Boolean  @default(false)
  isApproved   Boolean  @default(false)
  helpfulCount Int      @default(0)
  images       Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  product      Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([rating])
  @@index([isApproved])
  @@map("product_reviews")
}

model ProductPrice {
  id             String         @id @default(uuid())
  productId      String
  stablecoinType StablecoinType
  price          Decimal        @db.Decimal(20, 8)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  product        Product        @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, stablecoinType])
  @@index([productId])
  @@map("product_prices")
}

model Order {
  id                 String         @id @default(uuid())
  userId             String
  orderNumber        String         @unique
  stablecoinType     StablecoinType
  subtotal           Decimal        @default(0) @db.Decimal(20, 8)
  tax                Decimal        @default(0) @db.Decimal(20, 8)
  total              Decimal        @default(0) @db.Decimal(20, 8)
  status             OrderStatus    @default(PENDING)
  shippingAddress    Json?
  trackingNumber     String?
  metadata           Json?
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
  paidAt             DateTime?
  shippedAt          DateTime?
  deliveredAt        DateTime?
  cancelledAt        DateTime?
  blockNumber        String?
  buyerAddress       String?
  network            NetworkType?
  paymentConfirmedAt DateTime?
  platformFee        Decimal        @default(0) @db.Decimal(20, 8)
  shippingAddressId  String?
  totalAmount        Decimal        @default(0) @db.Decimal(20, 8)
  transactionHash    String?        @unique
  items              OrderItem[]
  shippingAddr       UserAddress?   @relation(fields: [shippingAddressId], references: [id])
  user               User           @relation(fields: [userId], references: [id])
  transactions       Transaction?

  @@index([userId])
  @@index([status])
  @@index([orderNumber])
  @@index([createdAt])
  @@index([transactionHash])
  @@map("orders")
}

model OrderItem {
  id             String         @id @default(uuid())
  orderId        String
  productId      String
  quantity       Int
  stablecoinType StablecoinType
  pricePerUnit   Decimal        @db.Decimal(20, 8)
  totalPrice     Decimal        @db.Decimal(20, 8)
  metadata       Json?
  order          Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product        Product        @relation(fields: [productId], references: [id])

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

model Notification {
  id        String              @id @default(uuid())
  userId    String?
  type      NotificationType
  channel   NotificationChannel
  recipient String
  subject   String?
  message   String
  metadata  Json?
  sentAt    DateTime?
  status    String              @default("pending")
  createdAt DateTime            @default(now())

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("notifications")
}

model AuditLog {
  id         String      @id @default(uuid())
  userId     String?
  action     AuditAction
  entityType String?
  entityId   String?
  ipAddress  String?
  userAgent  String?
  metadata   Json?
  createdAt  DateTime    @default(now())
  user       User?       @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

model SystemConfig {
  id        String   @id @default(uuid())
  key       String   @unique
  value     Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("system_config")
}

model ExchangeRate {
  id             String         @id @default(uuid())
  stablecoinType StablecoinType
  fiatCurrency   String
  rate           Decimal        @db.Decimal(20, 8)
  provider       String
  validUntil     DateTime
  createdAt      DateTime       @default(now())

  @@unique([stablecoinType, fiatCurrency])
  @@index([validUntil])
  @@map("exchange_rates")
}

model ApiKey {
  id                  String             @id @default(uuid())
  userId              String
  name                String
  keyHash             String             @unique
  secretHash          String?
  prefix              String
  status              ApiKeyStatus       @default(ACTIVE)
  lastUsedAt          DateTime?
  expiresAt           DateTime?
  rateLimitPerMinute  Int                @default(60)
  rateLimitPerDay     Int                @default(10000)
  subscriptionTier    String             @default("free")
  monthlyQuota        Int                @default(1000)
  usageThisMonth      Int                @default(0)
  billingResetAt      DateTime?
  commissionRate      Decimal            @default(0.05) @db.Decimal(5, 4)
  totalEarnings       Decimal            @default(0) @db.Decimal(20, 8)
  pendingEarnings     Decimal            @default(0) @db.Decimal(20, 8)
  availableEarnings   Decimal            @default(0) @db.Decimal(20, 8)
  payoutWalletAddress String?
  payoutNetwork       NetworkType?
  webhookUrl          String?
  webhookSecret       String?
  metadata            Json?
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  revokedAt           DateTime?
  creationFeeAmount   Decimal?           @db.Decimal(20, 8)
  creationFeePaid     Boolean            @default(false)
  creationFeeTxHash   String?
  supportedNetworks   NetworkType[]
  isTestnetMode       Boolean            @default(false) // If true, uses testnet networks for all transactions
  adClicks            AdClick[]
  user                User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  usageLogs           ApiUsageLog[]
  payouts             CommissionPayout[]
  commissions         Commission[]
  externalOrders      ExternalOrder[]

  @@index([userId])
  @@index([keyHash])
  @@index([status])
  @@index([prefix])
  @@map("api_keys")
}

model ApiUsageLog {
  id             String   @id @default(uuid())
  apiKeyId       String
  endpoint       String
  method         String
  statusCode     Int
  responseTimeMs Int
  ipAddress      String?
  userAgent      String?
  requestBody    Json?
  createdAt      DateTime @default(now())
  apiKey         ApiKey   @relation(fields: [apiKeyId], references: [id], onDelete: Cascade)

  @@index([apiKeyId])
  @@index([createdAt])
  @@index([endpoint])
  @@map("api_usage_logs")
}

model AdClick {
  id                  String         @id @default(uuid())
  apiKeyId            String
  productId           String
  clickToken          String         @unique
  customerSessionId   String?
  customerPreferences Json?
  clickedAt           DateTime?
  convertedAt         DateTime?
  orderId             String?        @unique
  metadata            Json?
  createdAt           DateTime       @default(now())
  expiresAt           DateTime
  apiKey              ApiKey         @relation(fields: [apiKeyId], references: [id], onDelete: Cascade)
  order               ExternalOrder? @relation(fields: [orderId], references: [id])
  product             Product        @relation(fields: [productId], references: [id])

  @@index([apiKeyId])
  @@index([productId])
  @@index([clickToken])
  @@index([createdAt])
  @@map("ad_clicks")
}

model ExternalCustomer {
  id                 String                     @id @default(uuid())
  phone              String?                    @unique
  countryCode        String?
  email              String?                    @unique
  emailVerified      Boolean                    @default(false)
  phoneVerified      Boolean                    @default(false)
  verificationStatus CustomerVerificationStatus @default(PENDING)
  lastVerifiedAt     DateTime?
  fullName           String?
  addressLine1       String?
  addressLine2       String?
  city               String?
  state              String?
  postalCode         String?
  country            String?
  landmark           String?
  riskScore          Int                        @default(0)
  isSuspicious       Boolean                    @default(false)
  lastActivityAt     DateTime?
  metadata           Json?
  createdAt          DateTime                   @default(now())
  updatedAt          DateTime                   @updatedAt
  depositAddresses   ExternalDepositAddress[]
  orders             ExternalOrder[]
  otpVerifications   ExternalOtpVerification[]

  @@index([phone])
  @@index([email])
  @@index([verificationStatus])
  @@map("external_customers")
}

model ExternalOtpVerification {
  id          String           @id @default(uuid())
  customerId  String
  type        String
  recipient   String
  otp         String
  attempts    Int              @default(0)
  maxAttempts Int              @default(5)
  verified    Boolean          @default(false)
  expiresAt   DateTime
  createdAt   DateTime         @default(now())
  customer    ExternalCustomer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([recipient])
  @@index([expiresAt])
  @@map("external_otp_verifications")
}

model ExternalDepositAddress {
  id             String               @id @default(uuid())
  customerId     String
  network        NetworkType
  stablecoinType StablecoinType
  address        String
  status         DepositAddressStatus @default(ACTIVE)
  assignedAt     DateTime             @default(now())
  lastUsedAt     DateTime?
  expiresAt      DateTime?
  pendingBalance Decimal              @default(0) @db.Decimal(20, 8)
  totalReceived  Decimal              @default(0) @db.Decimal(20, 8)
  metadata       Json?
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
  customer       ExternalCustomer     @relation(fields: [customerId], references: [id], onDelete: Cascade)
  orders         ExternalOrder[]

  @@unique([customerId, network, stablecoinType])
  @@index([customerId])
  @@index([address])
  @@index([status])
  @@index([expiresAt])
  @@map("external_deposit_addresses")
}

model ExternalOrder {
  id               String                  @id @default(uuid())
  apiKeyId         String
  customerId       String
  depositAddressId String?
  orderNumber      String                  @unique
  productId        String
  quantity         Int                     @default(1)
  stablecoinType   StablecoinType
  network          NetworkType?
  pricePerUnit     Decimal                 @db.Decimal(20, 8)
  subtotal         Decimal                 @db.Decimal(20, 8)
  tax              Decimal                 @default(0) @db.Decimal(20, 8)
  total            Decimal                 @db.Decimal(20, 8)
  status           ExternalOrderStatus     @default(INITIATED)
  depositAddress   String?
  expectedAmount   Decimal?                @db.Decimal(20, 8)
  receivedAmount   Decimal?                @db.Decimal(20, 8)
  txHash           String?                 @unique
  paymentExpiresAt DateTime?
  paidAt           DateTime?
  shippingAddress  Json?
  trackingNumber   String?
  shippedAt        DateTime?
  deliveredAt      DateTime?
  idempotencyKey   String?                 @unique
  metadata         Json?
  createdAt        DateTime                @default(now())
  updatedAt        DateTime                @updatedAt
  cancelledAt      DateTime?
  expiresAt        DateTime?
  adClick          AdClick?
  commission       Commission?
  apiKey           ApiKey                  @relation(fields: [apiKeyId], references: [id])
  customer         ExternalCustomer        @relation(fields: [customerId], references: [id])
  depositAddrRef   ExternalDepositAddress? @relation(fields: [depositAddressId], references: [id])
  product          Product                 @relation(fields: [productId], references: [id])
  webhookLogs      WebhookLog[]

  @@index([apiKeyId])
  @@index([customerId])
  @@index([status])
  @@index([orderNumber])
  @@index([txHash])
  @@index([idempotencyKey])
  @@index([createdAt])
  @@map("external_orders")
}

model WebhookLog {
  id            String           @id @default(uuid())
  orderId       String
  eventType     WebhookEventType
  webhookUrl    String
  payload       Json
  status        WebhookStatus    @default(PENDING)
  statusCode    Int?
  response      String?
  attempts      Int              @default(0)
  maxAttempts   Int              @default(5)
  lastAttemptAt DateTime?
  nextRetryAt   DateTime?
  deliveredAt   DateTime?
  createdAt     DateTime         @default(now())
  order         ExternalOrder    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([status])
  @@index([eventType])
  @@index([nextRetryAt])
  @@map("webhook_logs")
}

model Commission {
  id                 String            @id @default(uuid())
  apiKeyId           String
  externalOrderId    String            @unique
  orderTotal         Decimal           @db.Decimal(20, 8)
  commissionRate     Decimal           @default(0.05) @db.Decimal(5, 4)
  commissionAmount   Decimal           @db.Decimal(20, 8)
  stablecoinType     StablecoinType
  network            NetworkType?
  status             CommissionStatus  @default(PENDING)
  confirmedAt        DateTime?
  availableAt        DateTime?
  paidAt             DateTime?
  cancelledAt        DateTime?
  cancellationReason String?
  payoutId           String?
  metadata           Json?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  apiKey             ApiKey            @relation(fields: [apiKeyId], references: [id])
  externalOrder      ExternalOrder     @relation(fields: [externalOrderId], references: [id])
  payout             CommissionPayout? @relation(fields: [payoutId], references: [id])

  @@index([apiKeyId])
  @@index([status])
  @@index([createdAt])
  @@index([payoutId])
  @@map("commissions")
}

model CommissionPayout {
  id             String         @id @default(uuid())
  apiKeyId       String
  totalAmount    Decimal        @db.Decimal(20, 8)
  stablecoinType StablecoinType
  network        NetworkType
  walletAddress  String
  txHash         String?        @unique
  status         PayoutStatus   @default(PENDING)
  requestedAt    DateTime       @default(now())
  processedAt    DateTime?
  completedAt    DateTime?
  failedAt       DateTime?
  failureReason  String?
  metadata       Json?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  apiKey         ApiKey         @relation(fields: [apiKeyId], references: [id])
  commissions    Commission[]

  @@index([apiKeyId])
  @@index([status])
  @@index([createdAt])
  @@map("commission_payouts")
}

model SellerPayout {
  id             String             @id @default(uuid())
  sellerId       String
  grossAmount    Decimal            @db.Decimal(20, 8)
  platformFee    Decimal            @db.Decimal(20, 8)
  netAmount      Decimal            @db.Decimal(20, 8)
  stablecoinType StablecoinType
  network        NetworkType?
  payoutMethod   String
  walletAddress  String?
  bankReference  String?
  txHash         String?            @unique
  status         SellerPayoutStatus @default(PENDING)
  periodStart    DateTime
  periodEnd      DateTime
  requestedAt    DateTime?
  processedAt    DateTime?
  completedAt    DateTime?
  failedAt       DateTime?
  failureReason  String?
  approvedBy     String?
  approvedAt     DateTime?
  orderIds       Json?
  metadata       Json?
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  seller         Seller             @relation(fields: [sellerId], references: [id])

  @@index([sellerId])
  @@index([status])
  @@index([createdAt])
  @@map("seller_payouts")
}

enum UserRole {
  USER
  ADMIN
  SUPER_ADMIN
  EMPLOYEE
}

enum UserType {
  MOBILE
  WHALE
  MEMBER
  STANDARD
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  DEACTIVATED
}

enum KYCStatus {
  NOT_STARTED
  PENDING
  APPROVED
  REJECTED
  EXPIRED
}

enum StablecoinType {
  USDT
  USDC
  DAI
  BUSD
}

enum NetworkType {
  ETHEREUM
  POLYGON
  BSC
  ARBITRUM
  OPTIMISM
  AVALANCHE
  SUI
  TON
  BASE
  SOLANA
}

enum AddressType {
  SHIPPING
  BILLING
}

enum EmployeeRole {
  MERCHANT_ONBOARDING
  KYC_REVIEWER
  PRODUCT_MANAGER
  INVENTORY_MANAGER
  CUSTOMER_SUPPORT
}

enum EmployeePermission {
  VIEW_USERS
  EDIT_USERS
  DELETE_USERS
  VIEW_MERCHANTS
  APPROVE_MERCHANTS
  REJECT_MERCHANTS
  VIEW_KYC
  APPROVE_KYC
  REJECT_KYC
  VIEW_PRODUCTS
  CREATE_PRODUCTS
  EDIT_PRODUCTS
  DELETE_PRODUCTS
  VIEW_INVENTORY
  UPDATE_INVENTORY
  VIEW_ORDERS
  EDIT_ORDERS
  CANCEL_ORDERS
  VIEW_TICKETS
  RESPOND_TICKETS
  CLOSE_TICKETS
  VIEW_WITHDRAWALS
  APPROVE_WITHDRAWALS
  VIEW_ANALYTICS
  EXPORT_DATA
}

enum BlockchainNetwork {
  ETHEREUM
  AVALANCHE
  SUI
  TON
  BITCOIN
}

enum TransactionType {
  DEPOSIT
  WITHDRAWAL
  PURCHASE
  REFUND
  FIAT_PURCHASE
  TRANSFER_IN
  TRANSFER_OUT
}

enum TransactionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum FiatPaymentProvider {
  STRIPE
  RAZORPAY
}

enum FiatPaymentStatus {
  INITIATED
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

enum SellerType {
  MANUFACTURER
  DISTRIBUTOR
  WHOLESALER
  RETAILER
  AGENCY
  BRAND
  INDIVIDUAL
}

enum SellerStatus {
  PENDING_VERIFICATION
  VERIFIED
  SUSPENDED
  REJECTED
  DOCUMENTS_PENDING
  UNDER_REVIEW
  APPROVED
  ACTIVE
  PENDING_ONBOARDING
}

enum DocumentStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ProductStatus {
  ACTIVE
  INACTIVE
  OUT_OF_STOCK
  PENDING_REVIEW
  REJECTED
}

enum OrderStatus {
  PENDING
  PAYMENT_PENDING
  PROCESSING
  CONFIRMED
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
  PAID
}

enum NotificationType {
  OTP
  DEPOSIT_CONFIRMED
  WITHDRAWAL_COMPLETED
  ORDER_CONFIRMED
  KYC_APPROVED
  KYC_REJECTED
  PAYMENT_FAILED
  GENERAL
}

enum NotificationChannel {
  SMS
  EMAIL
  PUSH
  IN_APP
}

enum AuditAction {
  USER_LOGIN
  USER_LOGOUT
  KYC_SUBMITTED
  KYC_APPROVED
  KYC_REJECTED
  DEPOSIT_RECEIVED
  WITHDRAWAL_REQUESTED
  WITHDRAWAL_APPROVED
  ORDER_PLACED
  ORDER_CANCELLED
  FIAT_PURCHASE
  ADMIN_ACTION
  SETTINGS_CHANGED
  KYC_UPDATED
  WITHDRAWAL_COMPLETED
  WITHDRAWAL_FAILED
  ADDRESS_ADDED
  ADDRESS_UPDATED
  ADDRESS_DELETED
}

enum ApiKeyStatus {
  ACTIVE
  REVOKED
  EXPIRED
}

enum CustomerVerificationStatus {
  PENDING
  EMAIL_VERIFIED
  PHONE_VERIFIED
  FULLY_VERIFIED
}

enum DepositAddressStatus {
  ACTIVE
  EXPIRED
  USED
  SUSPENDED
}

enum ExternalOrderStatus {
  INITIATED
  AWAITING_VERIFICATION
  AWAITING_ADDRESS
  AWAITING_PAYMENT
  PAYMENT_DETECTED
  PAYMENT_CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
  EXPIRED
}

enum WebhookEventType {
  PAYMENT_INITIATED
  PAYMENT_DETECTED
  PAYMENT_CONFIRMED
  PAYMENT_FAILED
  PAYMENT_EXPIRED
  ORDER_PROCESSING
  ORDER_SHIPPED
  ORDER_DELIVERED
  ORDER_CANCELLED
  ORDER_REFUNDED
}

enum WebhookStatus {
  PENDING
  SENT
  DELIVERED
  FAILED
  RETRYING
}

enum CommissionStatus {
  PENDING
  CONFIRMED
  AVAILABLE
  PAID
  CANCELLED
}

enum PayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum SellerPayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  ON_HOLD
}

enum RewardType {
  REFERRAL_BONUS
  REFERRAL
  FIRST_PURCHASE
  PURCHASE_REWARD
  PURCHASE
  SIGNUP_BONUS
  MILESTONE
  SPECIAL_OFFER
  SUBSCRIPTION
}

model Reward {
  id            String         @id @default(uuid())
  userId        String
  type          RewardType
  amount        Decimal?       @db.Decimal(20, 8)
  currency      StablecoinType?
  points        Int            @default(0)
  status        String         @default("EARNED")
  description   String?
  referenceType String?
  referenceId   String?
  metadata      Json?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  claimedAt     DateTime?
  expiresAt     DateTime?
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([type])
  @@index([createdAt])
  @@map("rewards")
}

model NetworkConfig {
  id                 String      @id @default(uuid())
  network            NetworkType @unique
  isEnabled          Boolean     @default(true)
  displayName        String
  description        String?
  iconUrl            String?
  sortOrder          Int         @default(0)
  contractDeployed   Boolean     @default(false)
  contractAddress    String?
  lastContractCheck  DateTime?
  metadata           Json?
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt
  updatedBy          String?

  @@index([isEnabled])
  @@index([sortOrder])
  @@index([contractDeployed])
  @@map("network_configs")
}
